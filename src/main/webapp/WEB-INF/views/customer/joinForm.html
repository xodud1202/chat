<!DOCTYPE html>
<html lang="ko"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layout/BeforeLoginLayout}">
<!--
 *******************************************************************************
 * @source  : JoinForm.html
 * @desc	: 회원가입페이지 Page
 *============================================================================
 * nas
 * Copyright(C) 2022 xodud1202, All rights reserved.
 *============================================================================
 * VER  DATE		 AUTHOR	  DESCRIPTION
 * ===  ===========  ==========  =============================================
 * 1.0  2022.03.21   xodud1202   최초 작성
 *******************************************************************************
 -->

<body>
<th:block layout:fragment="content" th:with="uxImgUrl=${@environment.getProperty('domain.uximage')}">
	<!-- 회원가입 : 입력폼 -->
	<form id="joinForm" name="joinForm" method="post">
		<div class="row g-3">
			<div class="col-md-12 inputPadding text-center" style="margin-top:3rem;margin-bottom:3rem;">
				<h1 class="titleFont menuColor mainTitle">회원가입</h1>
			</div>

			<!-- 가입 아이디 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding displayBlock marginAuto floatUnset">
					<!--<label for="email" class="form-label">아이디 <span class="text-muted">(ID)</span></label>-->
					<input type="text" class="form-control" name="custId" id="custId" minlength="5" maxlength="40" placeholder="아이디" title="아이디" required />
					<ul class="validation-list" data-id="custId">
						<li data-name="length"><span>5자이상</span><i class="el-icon-check"></i></li>
						<li data-name="symbol"><span>특수문자불가</span><i class="el-icon-check"></i></li>
						<li data-name="double"><span>사용중인 아이디</span><i class="el-icon-check"></i></li>
					</ul>
				</div>
			</div>

			<!-- 패스워드 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding displayBlock marginAuto floatUnset">
					<input type="password" class="form-control" name="pwd" id="pwd" minlength="8" maxlength="20" required="required" placeholder="비밀번호" title="비밀번호"/>
					<button type="button" class="btn-lock-toggle"></button>
					<ul class="validation-list" data-id="pwd">
						<li data-name="english"><span>영문포함</span><i class="el-icon-check"></i></li>
						<li data-name="number"><span>숫자포함</span><i class="el-icon-check"></i></li>
						<li data-name="symbol"><span>특수문자포함(!@#$%^&*()?_~)</span><i class="el-icon-check"></i></li>
						<li data-name="length"><span>8자 이상</span><i class="el-icon-check"></i></li>
					</ul>
				</div>
			</div>

			<!-- 성명 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding displayBlock marginAuto floatUnset">
					<input type="text" class="form-control" name="custNm" id="custNm" placeholder="성명" title="성명"/>
					<ul class="validation-list" data-id="custNm">
						<li data-name="custNm" class="err red" style="display:none;"><span>이름을 입력해주세요</span><i class="el-icon-check"></i></li>
					</ul>
				</div>
			</div>

			<!-- 휴대폰번호 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding displayBlock marginAuto floatUnset">
					<input type="text" class="form-control" name="cellPhone" id="cellPhone" placeholder="휴대폰번호" title="휴대폰번호" maxlength="13"/>
					<ul class="validation-list" data-id="cellPhone">
						<li data-name="cellPhone" class="err red" style="display:none;"><span>휴대폰번호를 입력해주세요</span><i class="el-icon-check"></i></li>
					</ul>
				</div>
			</div>

			<!-- 이메일 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding displayBlock marginAuto floatUnset">
					<input type="text" class="form-control" name="email" id="email" placeholder="이메일" title="이메일" maxlength="30"/>
					<ul class="validation-list" data-id="email">
						<li data-name="email" class="err red" style="display:none;"><span>이메일 형식오류</span><i class="el-icon-check"></i></li>
					</ul>
				</div>
			</div>

			<!-- 성별 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding pt2r pb1r borderTop1px displayBlock marginAuto floatUnset">
					<div class="mb1r">성별</div>
					<div class="form-check inlineBlock mr2r">
						<input class="form-check-input" type="radio" name="sexType" id="sexTypeMan" value="M" checked>
						<label class="form-check-label" for="sexTypeMan">남자</label>
					</div>
					<div class="form-check inlineBlock">
						<input class="form-check-input" type="radio" name="sexType" id="sexTypeWoman" value="W">
						<label class="form-check-label" for="sexTypeWoman">여자</label>
					</div>
				</div>
			</div>

			<!-- 마케팅 수신동의 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding pt2r pb1r borderTop1px displayBlock marginAuto floatUnset">
					<div class="mb1r">마케팅 수신동의</div>
					<div class="form-check inlineBlock mr2r">
						<input class="form-check-input" type="checkbox" name="mailRecvYn" id="mailRecvYn" value="Y">
						<label class="form-check-label" for="mailRecvYn">E-MAIL</label>
					</div>
					<div class="form-check inlineBlock">
						<input class="form-check-input" type="checkbox" name="smsRecvYn" id="smsRecvYn" value="Y">
						<label class="form-check-label" for="smsRecvYn">SMS</label>
					</div>
				</div>
			</div>

			<!-- 약관동의 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding pt2r pb1r borderTop1px displayBlock marginAuto floatUnset">
					<div class="mb1r">서비스 약관에 동의해주세요</div>
					<div class="form-check inlineBlock">
						<input class="form-check-input" type="checkbox" id="ta0" onclick="chkBoxAllCheck(this,'ckGroup1')">
						<label class="form-check-label" for="ta0">
							<strong>모두 동의</strong>
							<span>(선택 정보 포함)</span>
						</label>
					</div>
					<div id="ckGroup1" class="pl2r">
						<div class="form-check" data-id="age">
							<input class="form-check-input" type="checkbox" name="chkPolicies1" id="chkPolicies1">
							<label class="form-check-label" for="chkPolicies1">
								[필수] 만 14세 이상
							</label>
							<ul class="validation-list inlineBlock" data-id="age">
								<li data-name="age" class="err red" style="display:none; margin:0 0 0 1rem;"><span>체크 필수항목</span><i class="el-icon-check"></i></li>
							</ul>
						</div>

						<div class="form-check" data-id="term">
							<input class="form-check-input" type="checkbox" name="chkPolicies2" id="chkPolicies2">
							<label class="form-check-label" for="chkPolicies2">
								[필수] 이용약관 동의<a href="javascript:void(0);" onclick="fnPopupOpen('term');" data-bs-toggle="modal" data-bs-target="#layerPopup">보기</a>
							</label>
							<ul class="validation-list inlineBlock" data-id="term">
								<li data-name="term" class="err red" style="display:none; margin:0 0 0 1rem;"><span>체크 필수항목</span><i class="el-icon-check"></i></li>
							</ul>
						</div>

						<div class="form-check" data-id="privacy">
							<input class="form-check-input" type="checkbox" name="chkPolicies3" id="chkPolicies3">
							<label class="form-check-label" for="chkPolicies3">
								[필수] 개인정보 처리방침 동의<a href="javascript:void(0);" onclick="fnPopupOpen('privacy');" data-bs-toggle="modal" data-bs-target="#layerPopup">보기</a>
							</label>
							<ul class="validation-list inlineBlock" data-id="privacy">
								<li data-name="privacy" class="err red" style="display:none; margin:0 0 0 1rem;"><span>체크 필수항목</span><i class="el-icon-check"></i></li>
							</ul>
						</div>
					</div>
				</div>
			</div>

			<!-- 회원가입 버튼 -->
			<div class="col-md-12 floatUnset">
				<div class="col-md-6 inputPadding pt2r pb1r borderTop1px displayBlock marginAuto floatUnset">
					<button type="button" class="btn btn-lg w-100" id="btnJoin" onclick="joinCustomer()">동의하고 가입하기</button>
				</div>
			</div>
		</div>
	</form>

<script th:inline="javascript">
	/*<![CDATA[*/
	/**
	 * 클래스 포함여부 확인
	 * @param id - id
	 * @param dataNm - data-name
	 * @param classNm - 클래스명
	 */
	const fnGetCheckClass = (id, dataNm, classNm) => {
		return document.querySelector(`[data-id=${id}] [data-name=${dataNm}]`).classList.contains(classNm);
	};

	//1. 아이디 체크
	const fnValidationCustId = () => {
		const custId = document.joinForm.custId.value;
		const $custIdParentElement = document.joinForm.custId.parentElement;

		let isValidCustId = true;
		if(!isNull(custId)) {
			const $valiLengthElement = $custIdParentElement.querySelector(".validation-list li[data-name=length]");
			const $valiSpecialCharElement = $custIdParentElement.querySelector(".validation-list li[data-name=symbol]");
			let isValidCustId = true;
			//1-1. 길이
			if(custId.length > 4) {
				$valiLengthElement.classList.add("skyblue");
				$valiLengthElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiLengthElement.classList.add("red");
				$valiLengthElement.classList.remove("skyblue");
			}
			//1-2. 특수문자 체크 (입력불가)
			if(!fnCheckSpecialChar(custId)) {
				$valiSpecialCharElement.classList.add("skyblue");
				$valiSpecialCharElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiSpecialCharElement.classList.add("red");
				$valiSpecialCharElement.classList.remove("skyblue");
			}
			//1-3. 아이디 중복여부
			ltyJsonFetch("GET", `/customer/id/count?custId=${custId}`, null, (result) => {
				if(result === 0) {
					// 중복 계정이 없을 경우
					$custIdParentElement.querySelector(".validation-list li[data-name=double]").classList.add("skyblue");
					$custIdParentElement.querySelector(".validation-list li[data-name=double]").classList.remove("red");
				} else {
					// 중복 계정 존재할 경우
					isValidCustId = false;
					$custIdParentElement.querySelector(".validation-list li[data-name=double]").classList.add("red");
					$custIdParentElement.querySelector(".validation-list li[data-name=double]").classList.remove("skyblue");
				}
			})
		} else {
			$custIdParentElement.querySelector(".validation-list li").classList.remove("red");
			$custIdParentElement.querySelector(".validation-list li").classList.remove("skyblue");
			$custIdParentElement.querySelector(".validation-list li[data-name=length]").classList.add("red");

			isValidCustId = false;
		}

		if(isValidCustId) {
			document.joinForm.custId.classList.add("value_valid");
			document.joinForm.custId.classList.remove("value_invalid");
		} else {
			document.joinForm.custId.classList.add("value_invalid");
			document.joinForm.custId.classList.remove("value_valid");
		}
	}

	//2. 비밀번호 체크
	const fnValidationPassWord = () => {
		// password value
		const pwd = document.joinForm.pwd.value;
		// password input parent div element
		const $passwordParent = document.joinForm.pwd.parentElement;
		let isValidCustId = true;

		if(!isNull(pwd)) {
			const $valiEngElement = $passwordParent.querySelector(".validation-list li[data-name=english]");
			const $valiNumberElement = $passwordParent.querySelector(".validation-list li[data-name=number]");
			const $valiSpecialCharElement = $passwordParent.querySelector(".validation-list li[data-name=symbol]");
			const $valiLengthElement = $passwordParent.querySelector(".validation-list li[data-name=length]");

			//2-1.영문포함
			if(fnValidtaionEng(pwd)) {
				$valiEngElement.classList.add("skyblue");
				$valiEngElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiEngElement.classList.add("red");
				$valiEngElement.classList.remove("skyblue");
			}
			//2-2.숫자포함
			if(fnValidtaionNumber(pwd)) {
				$valiNumberElement.classList.add("skyblue");
				$valiNumberElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiNumberElement.classList.add("red");
				$valiNumberElement.classList.remove("skyblue");
			}
			//2-3.특수문자
			if(fnValidtaionSpecialChar(pwd)) {
				$valiSpecialCharElement.classList.add("skyblue");
				$valiSpecialCharElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiSpecialCharElement.classList.add("red");
				$valiSpecialCharElement.classList.remove("skyblue");
			}

			//2-4.길이 ( 8-20자 )
			if(fnValidationPwdLength(pwd)) {
				$valiLengthElement.classList.add("skyblue");
				$valiLengthElement.classList.remove("red");
			}else{
				isValidCustId = false;
				$valiLengthElement.classList.add("red");
				$valiLengthElement.classList.remove("skyblue");
			}
		} else {
			isValidCustId = false;
			$passwordParent.querySelector(".validation-list li").classList.add("red");
			$passwordParent.querySelector(".validation-list li").classList.remove("skyblue");
		}

		if(isValidCustId) {
			document.joinForm.pwd.classList.add("value_valid");
			document.joinForm.pwd.classList.remove("value_invalid");
		} else {
			document.joinForm.pwd.classList.add("value_invalid");
			document.joinForm.pwd.classList.remove("value_valid");
		}
	}

	//3. 이메일 체크
	const fnValidationEmail = () => {
		const email = document.joinForm.email.value;
		if(!isNull(email)) {
			if (!fnCheckValidationEmail(email)) {
				document.joinForm.querySelector(".row .validation-list li[data-name=email]").style.display = "block";
				document.joinForm.email.classList.add("value_invalid");
				document.joinForm.email.classList.remove("value_valid");
			} else {
				document.joinForm.querySelector(".row .validation-list li[data-name=email]").style.display = "none";
				document.joinForm.email.classList.add("value_valid");
				document.joinForm.email.classList.remove("value_invalid");
			}
		} else {
			document.joinForm.querySelector(".row .validation-list li[data-name=email]").style.display = "block";
			document.joinForm.email.classList.add("value_invalid");
			document.joinForm.email.classList.remove("value_valid");
		}
	}

	//4. 이름 체크
	const fnValidationCustNm = () => {
		let custNm = document.joinForm.custNm.value;
		if(!isNull(custNm)) {
			document.joinForm.querySelector(".row .validation-list li[data-name=custNm]").style.display = "none";
			document.joinForm.custNm.classList.add("value_valid");
			document.joinForm.custNm.classList.remove("value_invalid");
		} else {
			document.joinForm.querySelector(".row .validation-list li[data-name=custNm]").style.display = "block";
			document.joinForm.custNm.classList.add("value_invalid");
			document.joinForm.custNm.classList.remove("value_valid");
		}
	}

	//5. 휴대폰번호 체크
	const fnValidationhCellPhone = () => {
		let cellPhone = document.joinForm.cellPhone.value;
		if(!isNull(cellPhone)) {
			document.joinForm.querySelector(".row .validation-list li[data-name=cellPhone]").style.display = "none";
			document.joinForm.cellPhone.classList.add("value_valid");
			document.joinForm.cellPhone.classList.remove("value_invalid");
		} else {
			document.joinForm.querySelector(".row .validation-list li[data-name=cellPhone]").style.display = "block";
			document.joinForm.cellPhone.classList.add("value_invalid");
			document.joinForm.cellPhone.classList.remove("value_valid");
		}
	}

	//6. 약관동의 체크
	const fnValidationPolicy = () => {
		const $policies1 = document.joinForm.chkPolicies1;
		const $policies2 = document.joinForm.chkPolicies2;
		const $policies3 = document.joinForm.chkPolicies3;

		const $policy_em1 = document.joinForm.querySelector(".row .validation-list li[data-name=age]");
		const $policy_em2 = document.joinForm.querySelector(".row .validation-list li[data-name=term]");
		const $policy_em3 = document.joinForm.querySelector(".row .validation-list li[data-name=privacy]");

		//필수값 체크여부 메세지 보이기
		if (!$policies1.checked) {
			$policy_em1.style.display="block";
		}else{
			$policy_em1.style.display="none";
		}
		if (!$policies2.checked) {
			$policy_em2.style.display="block";
		}else{
			$policy_em2.style.display="none";
		}
		if (!$policies3.checked) {
			$policy_em3.style.display="block";
		}else{
			$policy_em3.style.display="none";
		}
	}

	//7. 에러 일괄확인
	const fnGetErrorCount = () => {
		let errorCnt = 0;
		// 아이디 확인(아이디 중복여부는 ajax재호출로 확인함)
		if(fnGetCheckClass('custId', 'length', 'red')) errorCnt++;
		if(fnGetCheckClass('custId', 'symbol', 'red')) errorCnt++;
		// 패스워드 확인
		if(fnGetCheckClass('pwd', 'english','red')) errorCnt++;
		if(fnGetCheckClass('pwd', 'number', 'red')) errorCnt++;
		if(fnGetCheckClass('pwd', 'symbol', 'red')) errorCnt++;
		if(fnGetCheckClass('pwd', 'length', 'red')) errorCnt++;
		// 이메일 확인
		if($('#email').hasClass('value_invalid')) errorCnt++;
		// 성명 확인
		if($('#custNm').hasClass('value_invalid')) errorCnt++;
		// 휴대폰번호 확인
		if($('#cellPhone').hasClass('value_invalid')) errorCnt++;
		// 약관동의여부
		if(!$('#chkPolicies1').is(':checked')) errorCnt++;
		if(!$('#chkPolicies2').is(':checked')) errorCnt++;
		if(!$('#chkPolicies3').is(':checked')) errorCnt++;

		return errorCnt;
	}

	//회원가입 처리후 페이지 이동
	const fnJoinSaveCallback = (result) => {
		if(result.isJoin === true) {
			document.location.href = "/";
		} else {
			alert("회원가입이 실패하였습니다. 새로고침 후 재시도 부탁드립니다.");
		}
	};

	//회원가입 처리
	const fnJoinMember = () => {
		if(confirm("회원가입을 하시겠습니까?")) {
			document.getElementById("btnJoin").disabled = true;
			const customerInfo = {
				custId : document.joinForm.custId.value,
				pwd : document.joinForm.pwd.value,
				custNm : document.joinForm.custNm,
				cellPhone : document.joinForm.cellPhone.value,
				email : document.joinForm.email.value,
				sexType : document.joinForm.querySelector("input[type=radio][name=sexType]:checked").value,
				mailRecvYn : document.joinForm.mailRecvYn.checked ? "Y" : "N",
				smsRecvYn : document.joinForm.smsRecvYn.checked ? "Y" : "N"
			}


			ltyJsonFetch("POST", "/customer/info", customerInfo, fnJoinSaveCallback);
		}
	}

	//체크박스 전체선택
	function chkBoxAllCheck(el, grpId) {
		let $thisId = $("#"+grpId);
		$thisId.find('input').prop("checked", $(el).is(":checked"));
		fnValidationPolicy();
	};

	//휴대폰번호 : 하이픈 자동추가
	$(document).on("change keyup input", "#cellPhone", function() {
		$(this).val( $(this).val().replace(/[^0-9]/g, "").replace(/(^02|^0505|^1[0-9]{3}|^0[0-9]{2})([0-9]+)?([0-9]{4})$/,"$1-$2-$3").replace("--", "-") );
	});

	function fnPopupOpen(layerGbn) {
		if(layerGbn == "term") {
			$("#layerPopup .modal-title").text("이용약관");
			$("#layerPopup .modal-body").html([[${policy1}]]);
		} else if (layerGbn == "privacy") {
			$("#layerPopup .modal-title").text("개인정보 처리방침");
			$("#layerPopup .modal-body").html([[${policy2}]]);
		}
	}

	// 회원가입 버튼 클릭 이벤트 (회원가입)
	const joinCustomer = () => {
		//아이디체크
		fnValidationCustId();
		//비밀번호체크
		fnValidationPassWord();
		//이메일체크
		fnValidationEmail();
		//성명체크
		fnValidationCustNm();
		//휴대폰번호체크
		fnValidationhCellPhone();
		//약관동의 체크
		fnValidationPolicy();

		//유효성 검증에 모두 통과했을경우
		if(fnGetErrorCount() < 1 ){
			fnJoinMember();
		}
	};

	$(document).ready(function () {
		document.joinForm.custId.focus();

		//입력창을 벗어나는 시점에 유효성 체크
		document.joinForm.custId.addEventListener("blur", () => {
			fnValidationCustId();
		});
		document.joinForm.pwd.addEventListener("blur", () => {
			fnValidationPassWord();
		});
		document.joinForm.email.addEventListener("blur", () => {
			fnValidationEmail();
		});
		document.joinForm.custNm.addEventListener("blur", () => {
			fnValidationCustNm();
		});
		document.joinForm.cellPhone.addEventListener("blur", () => {
			fnValidationhCellPhone();
		});
		// checkbox change event
		const chkPolicies1 = document.joinForm.chkPolicies1;
		chkPolicies1.addEventListener("change", () => {
			if(chkPolicies1.checked) chkPolicies1.parentElement.querySelector("li[data-name=age]").style.display = "none";
		});
		const chkPolicies2 = document.joinForm.chkPolicies2;
		chkPolicies2.addEventListener("change", () => {
			if(chkPolicies2.checked) chkPolicies2.parentElement.querySelector("li[data-name=term]").style.display = "none";
		});
		const chkPolicies3 = document.joinForm.chkPolicies3;
		chkPolicies3.addEventListener("change", () => {
			if(chkPolicies3.checked) chkPolicies3.parentElement.querySelector("li[data-name=privacy]").style.display = "none";
		});
	});
	/*]]>*/
</script>
</th:block>
</body>
</html>